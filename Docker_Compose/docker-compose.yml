version: '3.8'

services:
  model_server:
    image: pytorch/torchserve:latest
    container_name: pet_model_server
    ports:
      - "8080:8080"
      - "8081:8081"
    volumes:
      - ./model-store:/home/model-server/model-store:ro
    restart: unless-stopped
    command: [
      "torchserve",
      "--start",
      "--model-store",
      "/home/model-server/model-store",
      "--models",
      "pet=pet.mar",
      "--foreground"
    ]

  api:
    build:
      context: ../2_FastAPI_Service
      dockerfile: Dockerfile
    container_name: pet_api
    ports:
      - "8000:8000"
    volumes:
      - ../models:/models:ro
    environment:
      - TORCHSERVE_URL=http://model_server:8080
    depends_on:
      - model_server
    restart: unless-stopped

  streamlit:
    build:
      context: ../4_Streamlit_Frontend
      dockerfile: Dockerfile
    container_name: pet_frontend
    ports:
      - "8501:8501"
    environment:
      - API_URL=http://api:8000/predict
    depends_on:
      - api
    restart: unless-stopped
